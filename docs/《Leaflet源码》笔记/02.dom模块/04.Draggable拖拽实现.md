---
title: Draggable拖拽实现
date: 2025-03-20 10:27:45
permalink: /pages/150969/
categories:
  - 《Leaflet源码》笔记
  - dom模块
tags:
  -
author:
  name: 东流
  link: https://github.com/Jinuss
---

```js
var START = Browser.touch ? "touchstart mousedown" : "mousedown";

export var Draggable = Evented.extend({
  options: {
    clickTolerance: 3,
  },
  initialize: function (element, dragStartTarget, preventOutline, options) {
    Util.setOptions(this, options);

    this._element = element;
    this._dragStartTarget = dragStartTarget || element;
    this._preventOutline = preventOutline;
  },
  enable: function () {
    if (this._enabled) {
      return;
    }

    DomEvent.on(this._dragStartTarget, START, this._onDown, this);

    this._enabled = true;
  },
  disable: function () {
    if (!this._enabled) {
      return;
    }
    if (Draggable._dragging === this) {
      this.finishDrag(true);
    }

    DomEvent.off(this._dragStartTarget, START, this._onDown, this);

    this._enabled = false;
    this._moved = false;
  },
  _onDown: function (e) {
    if (!this._enabled) {
      return;
    }

    this._moved = false;

    if (DomUtil.hasClass(this._element, "leaflet-zoom-anim")) {
      return;
    }

    if (e.touches && e.touches.length !== 1) {
      if (Draggable._dragging === this) {
        this.finishDrag();
      }
      return;
    }

    if (
      Draggable._dragging ||
      e.shiftKey ||
      (e.which !== 1 && e.button !== 1 && !e.touches)
    ) {
      return;
    }
    Draggable._dragging = this;

    if (this._preventOutline) {
      DomUtil.preventOutline(this._element);
    }

    DomUtil.disableImageDrag();
    DomUtil.disableTextSelection();

    if (this._moving) {
      return;
    }
    this.fire("down");

    var first = e.touches ? e.touches[0] : e,
      sizedParent = DomUtil.getSizedParentNode(this._element);

    this._startPoint = new Point(first.clientX, first.clientY);
    this._startPos = DomUtil.getPosition(this._element);
    this._parentScale = DomUtil.getScale(sizedParent);

    var mouseevent = e.type === "mousedown";
    DomEvent.on(
      document,
      mouseevent ? "mousemove" : "touchmove",
      this._onMove,
      this
    );
    DomEvent.on(
      document,
      mouseevent ? "mouseup" : "touchend touchcancel",
      this._onUp,
      this
    );
  },
  _onMove: function (e) {
    if (!this._enabled) {
      return;
    }

    if (e.touches && e.touches.length > 1) {
      this._moved = true;
      return;
    }

    var first = e.touches && e.touches.length === 1 ? e.touches[0] : e,
      offset = new Point(first.clientX, first.clientY)._subtract(
        this._startPoint
      );

    if (!offset.x && !offset.y) {
      return;
    }
    if (Math.abs(offset.x) + Math.abs(offset.y) < this.options.clickTolerance) {
      return;
    }
    offset.x /= this._parentScale.x;
    offset.y /= this._parentScale.y;

    DomEvent.preventDefault(e);

    if (!this._moved) {
      this.fire("dragstart");

      this._moved = true;

      DomUtil.addClass(document.body, "leaflet-dragging");

      this._lastTarget = e.target || e.srcElement;
      if (
        window.SVGElementInstance &&
        this._lastTarget instanceof window.SVGElementInstance
      ) {
        this._lastTarget = this._lastTarget.correspondingUseElement;
      }
      DomUtil.addClass(this._lastTarget, "leaflet-drag-target");
    }

    this._newPos = this._startPos.add(offset);
    this._moving = true;

    this._lastEvent = e;
    this._updatePosition();
  },
  _onUp: function () {
    if (!this._enabled) {
      return;
    }
    this.finishDrag();
  },
  _updatePosition: function (e) {
    var e = { originalEvent: this._lastEvent };
    this.fire("predrag", e);
    DomUtil.setPosition(this._element, this._newPos);
    this.fire("drag", e);
  },
  finishDrag: function (noInertia) {
    DomUtil.removeClass(document.body, "leaflet-dragging");

    if (this._lastTarget) {
      DomUtil.removeClass(this._lastTarget, "leaflet-drag-target");
      this._lastTarget = null;
    }

    DomEvent.off(document, "mousemove touchmove", this._onMove, this);
    DomEvent.off(document, "mouseup touchend touchcancel", this._onUp, this);

    DomUtil.enableImageDrag();
    DomUtil.enableTextSelection();

    var fireDragend = this._moved && this._moving;

    this._moving = false;
    Draggable._dragging = false;

    if (fireDragend) {
      this.fire("dragend", {
        noInertia: noInertia,
        distance: this._newPos.distanceTo(this._startPos),
      });
    }
  },
});
```
