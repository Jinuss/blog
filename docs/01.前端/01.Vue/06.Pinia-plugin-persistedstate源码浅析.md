---
title: pinia-plugin-persistedstateæºç æµ…æ
date: 2024-09-10 10:34:31
permalink: /pages/104472/
categories:
  - å‰ç«¯
  - Vue
tags:
  -
author:
  name: ä¸œæµ
  link: https://github.com/Jinuss
---

## æ¦‚è¿°

`Pinia`æ˜¯`vue3`çš„å®˜æ–¹æ¨èç”¨äºæ•°æ®å…±äº«çš„åº“ï¼Œä½†æ˜¯`PiniağŸ`ä¸­çš„æ•°æ®æ˜¯å­˜åœ¨äºæµè§ˆå™¨çš„å†…å­˜ä¸­ï¼Œå½“æµè§ˆå™¨åˆ·æ–°åï¼Œè¿™äº›æ•°æ®å°±ä¼šæ¶ˆå¤±ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å¯¹æ•°æ®åšæŒä¹…åŒ–å­˜å‚¨ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ°`pinia-plugin-persistedstate`ã€‚

`pinia-plugin-persistedstate`æœ¬è´¨ä¸Šåˆ©ç”¨æµè§ˆå™¨æŒä¹…åŒ–å­˜å‚¨åœ°èƒ½åŠ›ï¼Œé»˜è®¤ä½¿ç”¨`localStorage`ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»`pinia-plugin-persistedstate`çš„ä½¿ç”¨ä»¥åŠæºç å‰–æï¼Œä»¥`vue3`é¡¹ç›®ä¸ºä¾‹ã€‚

## `pinia-plugin-persistedstate`çš„ä½¿ç”¨

ä½¿ç”¨`pinia-plugin-persistedstate`ä¹‹å‰éœ€è¦å®‰è£…`pinia`å’Œ`pinia-plugin-persistedstate`ã€‚å…¶ä½¿ç”¨ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†

- åœ¨`main.js`ä¸­å¼•ç”¨ï¼Œå¦‚ç¤ºä¾‹ï¼š

```js
import piniaPluginPersistedstate from "pinia-plugin-persistedstate";
const pinia = createPinia();
pinia.use(piniaPluginPersistedstate);
```

- åœ¨`store`ä¸­ä½¿ç”¨ï¼Œ`pinia`çš„`defineStore`çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œæä¾›ä¸€ä¸ª`persist`å±æ€§ï¼Œé…ç½®è¯¥å±æ€§å³å¯ã€‚

```js
export const useCommonStore = defineStore("common", {
  persist: {
    key: "common", // localStorageçš„å»º
    storage: localStorage, //æŒ‡å®šå­˜å‚¨æ–¹å¼,é»˜è®¤ä¸ºlocalStorage
    paths: ["menuActiveIndex", "collapse", "state", "currentMenuList"], // æ•°ç»„ä¸­çš„ä¸ºstateçš„é”®ï¼Œéœ€è¦æŒä¹…åŒ–çš„stateæ”¾åœ¨pathsä¸­
  },
});
```

- å…¶æ•ˆæœå¦‚ä¸‹
  <img src="../../Demo/image/storage01.png"/>

## æºç å‰–æ

`pinia-plugin-persistedstate`æ˜¯ä¸º `pinia`é‡èº«å®šåˆ¶çš„æŒä¹…åŒ–æ–¹æ¡ˆï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¯¹`pinia`æœ‰ä¸€å®šçš„äº†è§£ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç« [Pinia æºç æµ…æ](https://jinuss.github.io/blog/pages/3183ee/)ï¼ŒPSï¼šè¯¥æ–‡ç« ä¼šæŒç»­æ›´æ–°ã€‚æœ¬æ–‡ä¼šåªè®²è§£`pinia`ä¸­ä¸`pinia-plugin-persistedstate`æœ‰å…³çš„éƒ¨åˆ†ã€‚

### `pinia.use` æ–¹æ³•

ç”±ä¸Šå¯çŸ¥ï¼Œé€šè¿‡`pinia.use`å»ä½¿ç”¨`pinia-plugin-persistedstate`ï¼Œ`pinia.use`å®ç°å¦‚ä¸‹ï¼š

```js
 use(plugin) {
    if (!this._a && !isVue2) {
        toBeInstalled.push(plugin);
    }
    else {
        _p.push(plugin);
    }
    return this;
},
```

è¯¥`use`æ–¹æ³•æ˜¯åœ¨`createPinia`ä¸­å®šä¹‰çš„ï¼Œè°ƒç”¨`use`æ–¹æ³•ï¼Œé¦–å…ˆä¼šåˆ¤æ–­`_a`æ˜¯å¦å­˜åœ¨ä»¥åŠå½“å‰æ˜¯`vue2`è¿˜æ˜¯`vue3`ï¼Œå¦‚æœå½“å‰`_a`ä¸å­˜åœ¨ï¼ˆå³è¿˜æ²¡æœ‰è°ƒç”¨`app.use(pinia)`ï¼‰å¹¶ä¸”æ˜¯`vue3`ï¼Œåˆ™å°†`pinia-plugin-persistedstate`æ’ä»¶æ”¾åˆ°`toBeInstalled`å˜é‡ä¸­ï¼Œå¦åˆ™å°†æ’ä»¶æ”¾å¤§`_p`ä¸­ã€‚

æ”¾åˆ°`toBeInstalled`çš„æ’ä»¶ä¼šåœ¨`pinia`è¢«`vue3`å®ä¾‹è°ƒç”¨`use`æ–¹æ³•æ—¶`push`åˆ°`_p`ä¸­:

```js
toBeInstalled.forEach((plugin) => _p.push(plugin));
```

ç”±æ­¤å¯çŸ¥ï¼Œ`pinia`ä¸­çš„æ’ä»¶å…¨éƒ¨åœ¨`_p`ä¸­ã€‚

### `pinia`ä½¿ç”¨æ’ä»¶

`pinia`å†…éƒ¨ä½¿ç”¨æ’ä»¶çš„éƒ¨åˆ†æ˜¯åœ¨`createSetupStore`ä¸­å®ç°çš„ï¼Œå³`defineStore`â€”â€”>`useStore`â€”â€”>`createSetupStore`ï¼Œå…¶å®ç°å¦‚ä¸‹ï¼š

```js
pinia._p.forEach((extender) => {
  /* istanbul ignore else */
  if (USE_DEVTOOLS) {
    //è°ƒè¯•éƒ¨åˆ†
    const extensions = scope.run(() =>
      extender({
        store,
        app: pinia._a,
        pinia,
        options: optionsForPlugin,
      })
    );
    Object.keys(extensions || {}).forEach((key) =>
      store._customProperties.add(key)
    );
    assign(store, extensions);
  } else {
    assign(
      store,
      scope.run(() =>
        extender({
          store,
          app: pinia._a,
          pinia,
          options: optionsForPlugin,
        })
      )
    );
  }
});
```

è¿™æ®µä»£ç å°±æ˜¯åœ¨ vue ç»„ä»¶ä¸­ä½¿ç”¨`store`çš„`useStore`æ–¹æ³•æ—¶å»éå†`pinia`å®‰è£…çš„æ’ä»¶ï¼Œè°ƒç”¨æ’ä»¶æš´éœ²çš„æ–¹æ³•`extender`,å¯¹åº”`pinia-plugin-persistedstate`å°±æ˜¯è¯¥æ’ä»¶æš´éœ²çš„æ–¹æ³•`createPersistedState`,å°†`store`ã€`app`(å³ vue å®ä¾‹)ã€`pinia`ã€` options: optionsForPlugin`ä¼ ç»™æ’ä»¶

### `pinia-plugin-persistedstate`

`pinia-plugin-persistedstate`åªæš´éœ²äº†ä¸€ä¸ªæ¥å£ï¼š`createPersistedState`,é»˜è®¤æš´éœ²`createPersistedState()`çš„å®ä¾‹

#### `createPersistedState`

`createPersistedState` æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå…¶å®ç°å¦‚ä¸‹ï¼š

```js
function createPersistedState(factoryOptions = {}) {
  return (context) => {
    const { auto = false } = factoryOptions;
    const {
      options: { persist = auto },
      store,
      pinia,
    } = context;
    if (!persist) return;
    if (!(store.$id in pinia.state.value)) {
      const original_store = pinia._s.get(store.$id.replace("__hot:", ""));
      if (original_store)
        Promise.resolve().then(() => original_store.$persist());
      return;
    }
    const persistences = (
      Array.isArray(persist)
        ? persist.map((p) => normalizeOptions(p, factoryOptions))
        : [normalizeOptions(persist, factoryOptions)]
    )
      .map(parsePersistence(factoryOptions, store))
      .filter(Boolean);
    store.$persist = () => {
      persistences.forEach((persistence) => {
        persistState(store.$state, persistence);
      });
    };
    store.$hydrate = ({ runHooks = true } = {}) => {
      persistences.forEach((persistence) => {
        const { beforeRestore, afterRestore } = persistence;
        if (runHooks) beforeRestore == null ? void 0 : beforeRestore(context);
        hydrateStore(store, persistence);
        if (runHooks) afterRestore == null ? void 0 : afterRestore(context);
      });
    };
    persistences.forEach((persistence) => {
      const { beforeRestore, afterRestore } = persistence;
      beforeRestore == null ? void 0 : beforeRestore(context);
      hydrateStore(store, persistence);
      afterRestore == null ? void 0 : afterRestore(context);
      store.$subscribe(
        (_mutation, state) => {
          persistState(state, persistence);
        },
        {
          detached: true,
        }
      );
    });
  };
}
```

æ¥å—çš„å‚æ•°`context`å°±æ˜¯`pinia`ä¸­ä¼ è¿‡æ¥çš„`store`ã€`app`ã€`pinia`ã€` options`ã€‚

è‹¥ä½¿ç”¨`defineStore`æ—¶ï¼Œæ²¡æœ‰é…ç½®`persist`å±æ€§ï¼Œåˆ™`context`ä¸­`options`çš„`persist`å–`factoryOptions`çš„`auto`çš„å€¼ï¼Œé»˜è®¤ä¸º`false`ï¼Œæ­¤æ—¶ï¼Œå‡½æ•°å°±ç»ˆæ­¢,`return`ã€‚

ç„¶åæ’ä»¶ä¼šæ£€æŸ¥`store`æ˜¯å¦å­˜åœ¨äº`pinia.state.value`ä¸­,`pinia.state.value`æ˜¯ä¸€ä¸ªåŒ…å«æ‰€æœ‰å½“å‰å­˜å‚¨å®ä¾‹çš„å¯¹è±¡ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™å¤„ç†ä¸‹çƒ­åŠ è½½çš„å‰ç¼€å¹¶ä»`pinia._s`ä¸­è·å–åŸå§‹çš„å­˜å‚¨å®ä¾‹ï¼Œå¦‚æœåŸå§‹å®ä¾‹å­˜åœ¨ï¼Œåˆ™ç”¨`promise`å°†å…¶`$persist`æ–¹æ³•æ”¾åœ¨å¾®ä»»åŠ¡å¯¹åˆ—ä¸­å»æ‰§è¡Œã€‚

è‹¥`store`å­˜åœ¨ï¼Œåˆ™åˆ¤æ–­`persist`æ˜¯æ•°ç»„è¿˜æ˜¯å¯¹è±¡ã€‚è‹¥`persist`æ˜¯æ•°ç»„ï¼Œåˆ™å¯¹å®ƒéå†ï¼Œæ‰§è¡Œ`normalizeOptions`æ–¹æ³•ï¼›å¦åˆ™ç›´æ¥è°ƒç”¨`normalizeOptions`,ç„¶ååŒ…è£…æˆæ•°ç»„ï¼Œéå†ï¼Œæ‰§è¡Œ`parsePersistence`æ–¹æ³•ã€‚

ç„¶åæ’ä»¶å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•`store.$persist`å’Œ`store.$hydrate`ã€‚`$persist`å°±æ˜¯éå†`persistences`ï¼Œå»æ‰§è¡Œ`persistState`æ–¹æ³•ï¼›`$hydrate`æ°´åˆï¼Œå°±æ˜¯ç”¨æ¥ä»å­˜å‚¨ä¸­æ¢å¤æ•°æ®åˆ°`store`ä¸­ï¼Œä½†æ˜¯åœ¨`pinia`å’Œ`pinia-plugin-persistedstate`ä¸­æœªçœ‹åˆ°ç›¸å…³è°ƒç”¨ã€‚

æœ€åæ’ä»¶éå†äº†`persistences`ï¼Œåœ¨è°ƒç”¨`hydrateStore`çš„å‰åä¼šåˆ¤æ–­`beforeRestore`å’Œ`afterRestore`æ˜¯å¦å®šä¹‰äº†ï¼Œè‹¥å­˜åœ¨ï¼Œåˆ™ç›´æ¥è°ƒç”¨ï¼Œæœ€åè¿˜è°ƒç”¨äº†`store.$subscribe`æ–¹æ³•è¿›è¡Œç›‘å¬`state`çš„æ”¹å˜ï¼Œè‹¥`state`å‘ç”Ÿäº†æ”¹å˜ï¼Œåˆ™ä¼šæ‰§è¡Œå›è°ƒå‡½æ•°`persistState`ï¼Œå…¶è¿‡ç¨‹å¦‚ä¸‹:

```js
const { beforeRestore, afterRestore } = persistence;
beforeRestore == null ? void 0 : beforeRestore(context);
hydrateStore(store, persistence);
afterRestore == null ? void 0 : afterRestore(context);
store.$subscribe(
  (_mutation, state) => {
    persistState(state, persistence);
  },
  {
    detached: true,
  }
);
```

#### è¾…åŠ©å‡½æ•°æˆ–æ–¹æ³•

#### `hydrateStore` æ–¹æ³•

`hydrateStore`æ–¹æ³•å°±æ˜¯ä»`storage`ä¸­å»å–æ•°æ®ï¼Œç„¶åè¿›è¡Œååºåˆ—åŒ–ï¼Œè°ƒç”¨`store.$patch`è¿›è¡Œæ›´æ–°`state`çš„æ•°æ®ï¼Œå…¶å®ç°å¦‚ä¸‹ï¼š

```js
function hydrateStore(store, { storage, serializer, key, debug }) {
  try {
    const fromStorage = storage == null ? void 0 : storage.getItem(key);
    if (fromStorage)
      store.$patch(
        serializer == null ? void 0 : serializer.deserialize(fromStorage)
      );
  } catch (e) {
    if (debug) console.error("[pinia-plugin-persistedstate]", e);
  }
}
```

##### `persistState` æ–¹æ³•

`persistState`æ–¹æ³•å°±æ˜¯ç›‘å¬`state`çš„å˜åŒ–ï¼Œå°†æ–°æ•°æ®è¿›è¡Œåºåˆ—åŒ–åå­˜å‚¨åˆ°`storage`ä¸­ï¼Œå…¶å®ç°å¦‚ä¸‹ï¼š

```js
function persistState(state, { storage, serializer, key, paths, debug }) {
  try {
    const toStore = Array.isArray(paths) ? pick(state, paths) : state;
    storage.setItem(key, serializer.serialize(toStore));
  } catch (e) {
    if (debug) console.error("[pinia-plugin-persistedstate]", e);
  }
}
```

`pick`æ–¹æ³•å°±æ˜¯é€šè¿‡`store`ä¸­å®šä¹‰çš„`paths`æ•°ç»„å»è·å–`state`ä¸­å¯¹åº”çš„å€¼ã€‚

##### `normalizeOption`

`normalizeOption`å°±æ˜¯é€šè¿‡`Proxy`åˆ›å»ºäº†ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œåœ¨è®¿é—®`options`æ—¶ï¼Œè‹¥`options`ä¸å­˜åœ¨è¯¥å±æ€§ï¼Œåˆ™ä»`factoryOptions`ä¸­è·å–ã€‚

å…¶å®ç°å¦‚ä¸‹ï¼š

```js
function normalizeOptions(options, factoryOptions) {
  options = isObject(options) ? options : /* @__PURE__ */ Object.create(null);
  return new Proxy(options, {
    get(target, key, receiver) {
      if (key === "key") return Reflect.get(target, key, receiver);
      return (
        Reflect.get(target, key, receiver) ||
        Reflect.get(factoryOptions, key, receiver)
      );
    },
  });
}
```

##### `parsePersistence`

`parsePersistence`å‡½æ•°å°±æ˜¯ç”¨æ¥è§£æ`store`ä¸­å®šä¹‰çš„`persist`,å…¶ä¸»è¦å®ç°å¦‚ä¸‹ï¼š

```js
const {
  storage = localStorage, //é»˜è®¤å­˜å‚¨
  beforeRestore = void 0,
  afterRestore = void 0,
  serializer = {
    serialize: JSON.stringify,
    deserialize: JSON.parse,
  },
  key = store.$id,
  paths = null,
  debug = false,
} = o;
return {
  storage,
  beforeRestore,
  afterRestore,
  serializer,
  key: ((_a = factoryOptions.key) != null ? _a : (k) => k)(
    typeof key == "string" ? key : key(store.$id)
  ),
  paths,
  debug,
};
```

ä»ä¸Šè¿°ä»£ç å¯ä»¥çœ‹å‡º,å¦‚æœ`key`å€¼æœªå®šä¹‰ï¼Œä¼šé‡‡ç”¨é»˜è®¤çš„`store.$id`ï¼Œè‹¥`key`æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™ç›´æ¥é‡‡ç”¨;å¦åˆ™æ‰§è¡Œ`key(store.$id)`;å¦å¤–é»˜è®¤çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å‡½æ•°`serializer`æ˜¯`JSON.stringify`å’Œ`JSON.parse`ã€‚è¿™é‡Œè¿˜æä¾›äº†ä¸¤ä¸ªé’©å­å‡½æ•°`beforeRestore`å’Œ`afterRestore`ã€‚

## æ€»ç»“

`pinia-plugin-persistedstate`æ’ä»¶çŸ­å°è€Œç²¾æ‚ï¼Œåˆ©ç”¨çš„è¿˜æ˜¯`localStorage`å’Œ`pinia`çš„èƒ½åŠ›è¿›è¡Œæ•°æ®çš„ç›‘å¬ã€å­˜å‚¨å’Œæ¢å¤ã€‚
