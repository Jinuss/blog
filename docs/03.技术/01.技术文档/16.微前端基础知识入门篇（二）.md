---
title: å¾®å‰ç«¯åŸºç¡€çŸ¥è¯†å…¥é—¨ç¯‡ï¼ˆäºŒï¼‰
date: 2024-11-23 16:05:20
permalink: /pages/44e222/
categories:
  - æŠ€æœ¯
  - æŠ€æœ¯æ–‡æ¡£
tags:
  - 
author: 
  name: ä¸œæµ
  link: https://github.com/Jinuss
---
### æ¦‚è¿°
åœ¨ä¸Šä¸€ç¯‡ä»‹ç»äº†ä¸€äº›å¾®å‰ç«¯çš„åŸºç¡€çŸ¥è¯†ï¼Œè¯¦è§[å¾®å‰ç«¯åŸºç¡€çŸ¥è¯†å…¥é—¨ç¯‡ä¸€](https://jinuss.github.io/blog/pages/cd692a/)ã€‚æœ¬æ–‡ä¸»è¦ä»‹ç»`qiankun`å¾®å‰ç«¯æ¡†æ¶çš„å®æˆ˜å…¥é—¨å†…å®¹ã€‚

### `qiankun`å¾®å‰ç«¯å®è·µ
é€šè¿‡`Vite`è„šæ‰‹æ¶åˆ†åˆ«åˆ›å»ºä¸‰ä¸ªç¨‹åºï¼Œä¸»åº”ç”¨**A**ä¸ºï¼š`vite`+`vue3`+`ts`,ä¸¤ä¸ªå¾®åº”ç”¨åˆ†åˆ«ä¸º**B**ï¼š`vite`+`vue3`+`ts`;**C**:`vite`+`React`+`ts`ã€‚å› ä¸º`qiankun`çš„å¾®åº”ç”¨æ˜¯æŠ€æœ¯æ— å…³æ€§ï¼Œå› æ­¤å¾®åº”ç”¨å¯ä»¥æ˜¯ä¸€ä¸ªç®€å•ç½‘é¡µ`html`,ä¹Ÿå¯ä»¥æ˜¯ä»»æ„å‰ç«¯æ¡†æ¶æ­å»ºçš„ä¸€ä¸ªç½‘é¡µåº”ç”¨ã€‚

ä¸‰ä¸ªåº”ç”¨åˆ†åˆ«å®‰è£…`qiankun`åº“ï¼Œç»ˆç«¯è¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š
```bash
yarn add qiankun
```

#### å¾®åº”ç”¨çš„æ³¨å†Œ
åœ¨ä¸»åº”ç”¨**A**ä¸­ç¨‹åºå…¥å£æ–‡ä»¶`src/main.ts`ä¸­æ³¨å†Œå¾®åº”ç”¨å¦‚ä¸‹ï¼š

```ts
import { createApp } from "vue";
import { registerMicroApps, start } from "qiankun";
import App from "./App.vue";

const app = createApp(App);

app.mount("#app");

registerMicroApps([
  {
    name: "B_App",
    entry: "//localhost:5157",
    container: "#main_container",
    activeRule: "/cb",
  },
  {
    name: "C_App",
    entry: "//localhost:5158",
    container: "#main_container",
    activeRule: "/c",
  },
]);
start();
```
- **ä»£ç åˆ†æ**

**`registerMicroApps`å‡½æ•°**
è¯¥å‡½æ•°æ˜¯åŸºäºè·¯ç”±å»é…ç½®å¾®åº”ç”¨ï¼Œå…¶è¯­æ³•ä¸ºï¼š`registerMicroApps(apps,lifeCycles?)`ã€‚
  - **å‚æ•°**
    - `apps`:å¿…é€‰ï¼Œå¾®åº”ç”¨çš„æ³¨å†Œä¿¡æ¯ï¼Œå…¶ç±»å‹ä¸º`Array<ReigsterableApp>`
    - `lifeCycles`:å¯é€‰ï¼Œå…¨å±€çš„å¾®åº”ç”¨ç”Ÿå‘½å‘¨æœŸé’©å­,å…¶ç±»å‹ä¸º`LifeCycles`
  - **ç±»å‹**
    - `RegisterableApp`:ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶å±æ€§å¦‚ä¸‹ï¼š
      - `name`:å¿…é€‰ï¼Œå¾®åº”ç”¨åç§°ä¸”å”¯ä¸€
      - `entry`:å¿…é€‰ï¼Œå¾®åº”ç”¨å…¥å£ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ï¼Œè¡¨ç¤ºå¾®åº”ç”¨è®¿é—®åœ°å€ï¼›ä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡ï¼Œå…¶å±æ€§`html`å¯¹åº”çš„å°±æ˜¯å¾®åº”ç”¨çš„`html`å†…å®¹å­—ç¬¦ä¸²
      - `container`:å¿…é€‰ï¼Œ`#main_container`ä¸ºå¾®åº”ç”¨åœ¨ä¸»åº”ç”¨æŒ‚è½½çš„å®¹å™¨ï¼Œå¯ä»¥æ˜¯ä¸»åº”ç”¨ä¸­ä»»æ„ä¸€ä¸ªå­˜åœ¨çš„`DOM`å…ƒç´ ï¼Œä¸”å¤šä¸ªå¾®åº”ç”¨ä¹‹é—´ä¹Ÿæ˜¯ç‹¬ç«‹çš„ï¼ŒæŒ‚è½½çš„å®¹å™¨è‡ªä¸å¿…ç›¸åŒã€‚
      - `activeRule`:å¿…é€‰ï¼Œå¾®åº”ç”¨çš„æ¿€æ´»è§„åˆ™ï¼Œå½“ä¸»åº”ç”¨çš„åœ°å€æ `url`åŒ¹é…åˆ°æ”¹è§„åˆ™æ—¶ï¼Œè¯¥å¾®åº”ç”¨å°±ä¼šè¢«æ¿€æ´»ï¼Œå…¶å€¼ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ã€æ•°ç»„å­—ç¬¦ä¸²æˆ–è€…æ•°ç»„å‡½æ•°ï¼Œå‡½æ•°æ¥å—çš„å‚æ•°å°±æ˜¯å½“å‰`location`,å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œ`true`è¡¨ç¤ºåŒ¹é…æˆåŠŸã€‚
      - `loader`:å¯é€‰ï¼Œç±»å‹æ˜¯ä¸€ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤º`loading`çŠ¶æ€ï¼Œå½“å…¶å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šè°ƒç”¨è¯¥å‡½æ•°
      - `props`:å¯é€‰ï¼Œç±»å‹æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥ç”¨äºä¸»åº”ç”¨ä¼ é€’ç»™å¾®åº”ç”¨çš„æ•°æ®
    
    - `LifeCycles`:ç”Ÿå‘½å‘¨æœŸé›†åˆï¼Œæ¯ä¸ªå±æ€§å€¼éƒ½æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªæ•°ç»„å‡½æ•°ï¼Œå‡½æ•°è¿”å›ä¸€ä¸ª`Promise`,æ¥å—çš„å‚æ•°æ˜¯`RegisterableApp`ç±»å‹çš„å¯¹è±¡ï¼Œå…¶å±æ€§å¯é€‰å€¼åˆ†åˆ«ä¸º`beforeLoad`,`beforeMount`,`afterMount`,`beforeUnmount`å’Œ`afterUnmount`

  
**`start()å‡½æ•°`**
`start()`å‡½æ•°ä¸»è¦ç”¨äºå¯åŠ¨`qiankun`ä¸»åº”ç”¨,å…¶å‚æ•°éƒ½æ˜¯å¯é€‰çš„ï¼Œå¦‚ä¸‹
   - `prefetch`ï¼šæ˜¯å¦å¼€å¯å¾®åº”ç”¨çš„é™æ€èµ„æºé¢„åŠ è½½ï¼Œé»˜è®¤å€¼æ˜¯`true`,å…¶å€¼å¯ä»¥ä¸ºä¸‹é¢å‡ ä¸ª
      - `true`:ç¬¬ä¸€ä¸ªå¾®åº”ç”¨`mountted`åï¼Œå¼€å§‹é¢„åŠ è½½å…¶ä½™å¾®åº”ç”¨çš„é™æ€èµ„æº
      - `all`:ä¸»åº”ç”¨`start`åå°±å¼€å§‹é¢„åŠ è½½æ‰€æœ‰å¾®åº”ç”¨é™æ€èµ„æº
      - `string[]`ï¼šåœ¨ç¬¬ä¸€ä¸ªå¾®åº”ç”¨ `mounted` åå¼€å§‹åŠ è½½æ•°ç»„å†…çš„å¾®åº”ç”¨èµ„æº  
      - `function`:è‡ªå®šä¹‰å¾®åº”ç”¨çš„èµ„æºåŠ è½½æ—¶æœº
   
   - `sandbox`:æ˜¯å¦å¼€å¯æ²™ç®±ï¼Œé»˜è®¤ä¸º`true`ï¼Œå…¶å€¼ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡`{strictStyleIsolation:boolean,experimentalStyleIsolation:boolean}`ï¼Œè¡¨ç¤ºæ˜¯å¦å¼€å¯ä¸¥æ ¼çš„æ ·å¼éš”ç¦»ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šä¸ºæ¯ä¸ªåº”ç”¨çš„å®¹å™¨åŒ…è£¹ä¸€ä¸ª`shadow dom`èŠ‚ç‚¹ï¼Œä»è€Œéš”ç¦»æ ·å¼ã€‚
   - `singular`:å¯é€‰ï¼Œè¡¨ç¤ºæ˜¯å¦æ˜¯å•å®ä¾‹åœºæ™¯ï¼Œå³åŒä¸€æ—¶é—´åªä¼šæ¸²æŸ“ä¸€ä¸ªå¾®åº”ç”¨ï¼Œé»˜è®¤ä¸º`true`
   - `fetch`:ç”¨æ¥å®šåˆ¶è¯·æ±‚å¾®åº”ç”¨èµ„æºçš„æ–¹å¼çš„ä¸€ä¸ªé…ç½®é¡¹ã€‚å®ƒå¯ä»¥ç”¨æ¥æ›¿æ¢é»˜è®¤çš„èµ„æºè·å–æ–¹å¼ã€‚å…è®¸å¼€å‘è€…è‡ªå®šä¹‰è·å–å¾®åº”ç”¨èµ„æºï¼ˆå¦‚ `JS`ã€`CSS` æ–‡ä»¶ç­‰ï¼‰çš„æ–¹å¼
   - `getPublicPath`:ç”¨æ¥è·å–å¾®åº”ç”¨çš„å…¬å…±è·¯å¾„
   - `getTemplate`:ç”¨äºåŠ¨æ€è·å–å¾®åº”ç”¨çš„ `HTML` æ¨¡æ¿
   - `excludeAssetFilter`: è¿‡æ»¤ä¸éœ€è¦åŠ è½½çš„é™æ€èµ„æºï¼Œä¼˜åŒ–æ€§èƒ½

#### å¾®åº”ç”¨çš„æ”¹é€ 
å‰é¢é€šè¿‡`Vite`åˆ›å»ºäº†ä¸¤ä¸ªåº”ç”¨`B`å’Œ`C`ï¼Œåœ¨è¿™ä¸¤ä¸ªåº”ç”¨ä¸­åˆ†åˆ«éƒ½å®‰è£…`qiankun`å’Œ`vite-plugin-qiankun`,ä½¿ä¹‹æˆä¸ºä¸€ä¸ªå¾®åº”ç”¨

##### `B`å¾®åº”ç”¨
`B`å¾®åº”ç”¨çš„æŠ€æœ¯ä½“ç³»æ˜¯`vite`+`vue3`+`ts`,åœ¨å…¶é…ç½®æ–‡ä»¶`vite.config.ts`ä¸­å¼•å…¥`qiankun`,é…ç½®å¦‚ä¸‹ï¼š

```ts
 import { defineConfig } from "vite";
import vue from "@vitejs/plugin-vue";
import qiankun from "vite-plugin-qiankun";

export default defineConfig({
  plugins: [vue(), qiankun("vue-B-app", { useDevMode: true })],
  server: {
    port: 5157, //å›ºå®šç«¯å£
  },
});
```

ç¬¬äºŒæ­¥å°±æ˜¯ä¿®æ”¹å…¶å…¥å£æ–‡ä»¶`main.ts`,å¦‚ä¸‹ï¼š

```ts
import { createApp } from "vue";
import {
  renderWithQiankun,
  qiankunWindow,
  QiankunProps,
} from "vite-plugin-qiankun/dist/helper";
import "./style.css";
import App from "./App.vue";

const app = createApp(App);

let root:any = null;

function render(props: QiankunProps) {
  const { container } = props;
  const node = container
    ? container.querySelector("#app")
    : document.getElementById("app");
  console.log("ğŸš€ ~ render ~ node:", node);
  root=app.mount(node)
  return root;
}

renderWithQiankun({
  mount(props: any) {
    root = render(props);
  },
  bootstrap() {},
  unmount(props: any) {
    console.log(props);
    root?.unmount();
  },
  update(props: any) {
    console.log(props);
  },
});

if (!qiankunWindow.__POWERED_BY_QIANKUN__) {
  root = render({});
}
```


##### `C`å¾®åº”ç”¨
`C`å¾®åº”ç”¨çš„æŠ€æœ¯ä½“ç³»æ˜¯`vite`+`react`+`ts`,ç”±äºéƒ½æ˜¯`vite`æ­å»ºçš„ï¼Œæ‰€ä»¥å…¶æ”¹åŠ¨ä¹Ÿå·®ä¸å¤šï¼Œä¸åŒçš„æ˜¯`main.ts`ä¸­`render`éƒ¨åˆ†ï¼Œå¦‚ä¸‹ï¼š

```ts
function render(props: QiankunProps) {
  const { container } = props;
  console.log("ğŸš€ ~ render ~ container:", container)
  const node = container
    ? container.querySelector("#root")
    : document.getElementById("root");
    console.log("ğŸš€ ~ render ~ node:", node)
  root = createRoot(node!);
  root.render(<App />);
  return root;
}
```
ä¹‹æ‰€ä»¥ä¸åŒæ˜¯å› ä¸º`vue3`å’Œ`React`æŒ‚è½½èŠ‚ç‚¹æ–¹å¼çš„åŒºåˆ«ï¼Œè¿™ä¸ª`render`å‡½æ•°å…¼é¡¾äº†å„è‡ªçš„å¾®åº”ç”¨**ç‹¬ç«‹è¿è¡Œ**å’Œ**ä½œä¸ºå¾®åº”ç”¨è¿è¡Œ**ä¸¤ç§æ–¹å¼ã€‚

##### `vite-plugin-qiankun`æ’ä»¶
é¡¾åæ€ä¹‰ï¼Œ`vite-plugin-qiankun`æ’ä»¶å°±æ˜¯ä¸º`vite`æ­å»ºçš„åº”ç”¨é‡èº«å®šåˆ¶çš„ä¸€æ¬¾æ’ä»¶ã€‚æˆ‘ä»¬å¯ä»¥æ¥åˆ†æå®ƒåœ¨ä¸Šè¿°ç”¨åˆ°çš„`renderWithQiankun`æ–¹æ³•å’Œ`qiankunWindow`å˜é‡ã€‚

- **`renderWithQiankun`**
å…¶å®ç°å¦‚ä¸‹ï¼š
```js
var renderWithQiankun = function (qiankunLifeCycle) {
    if (qiankunWindow === null || qiankunWindow === void 0 ? void 0 : qiankunWindow.__POWERED_BY_QIANKUN__) {
        if (!window.moudleQiankunAppLifeCycles) {
            window.moudleQiankunAppLifeCycles = {};
        }
        if (qiankunWindow.qiankunName) {
            window.moudleQiankunAppLifeCycles[qiankunWindow.qiankunName] = qiankunLifeCycle;
        }
    }
};
```
ç”±ä¸Šå¯çŸ¥ï¼Œ`renderWithQiankun`å‡½æ•°çš„ä½œç”¨å°±æ˜¯åœ¨ç¡®è®¤å½“å‰åº”ç”¨ä¸ºå¾®åº”ç”¨æ—¶ï¼Œä¼šå°†å…¶å‚æ•°æŒ‚è½½åˆ°å…¨å±€å¯¹è±¡`window.moudleQiankunAppLifeCycles`ä¸Šï¼Œ`qiankunName`å°±æ˜¯å¾®åº”ç”¨åœ¨åœ¨ä¸»åº”ç”¨æ³¨å†Œæ—¶çš„`name`å€¼ã€‚

- **`qiankunWindow`**
`qiankunWindow`æœ¬è´¨ä¸Šå°±æ˜¯`window`å¯¹è±¡ï¼Œå…¶å€¼å¦‚ä¸‹ï¼š
```js
var qiankunWindow = typeof window !== 'undefined' ? (window.proxy || window) : {}; //ä»£ç†ä¼˜å…ˆçº§æœ€é«˜
```