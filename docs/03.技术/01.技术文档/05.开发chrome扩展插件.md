---
title: å¼€å‘chromeæ‰©å±•æ’ä»¶
date: 2024-09-04 14:24:40
permalink: /pages/00e10f/
categories:
  - æŠ€æœ¯
  - æŠ€æœ¯æ–‡æ¡£
tags:
  -
author:
  name: ä¸œæµ
  link: https://github.com/Jinuss
---

### å¼•è¨€

åœ¨å‰ç«¯å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸€èˆ¬åˆ†ä¸ºä¸‰ä¸ªç¯å¢ƒï¼šå¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒã€‚è¿™ä¸‰ä¸ªç¯å¢ƒå¯¹äºå‰ç«¯è€Œè¨€ï¼Œä¸è¿‡å°±æ˜¯è¯·æ±‚çš„ API æ¥å£ä¸åŒç½¢äº†ã€‚å¦‚æœæ˜¯`vue3`é¡¹ç›®ï¼Œå¯ä»¥é€šè¿‡ `import.meta.env.MODE`æ¥åŒºåˆ†ç¯å¢ƒï¼Œå¯æ˜¯ç«™åœ¨åç«¯å…„å¼Ÿè§’åº¦ï¼Œå°±å¿…é¡»ä¿®æ”¹é…ç½®æ–‡ä»¶çš„åœ°å€æ‰èƒ½è°ƒè¯•ã€‚å¦‚æœè¦åœ¨æœ¬åœ°è°ƒè¯•ï¼Œå¿…é¡» clone å‰ç«¯ä»£ç éƒ¨ç½²æ‰è¡Œï¼Œè¿™æä¸ºä¸æ–¹ä¾¿ã€‚ä¸ºæ­¤ï¼Œæˆ‘å¼€å‘äº†ä¸€ä¸ª Chrome æ’ä»¶ç”¨äºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸é¡¹ç›®çš„é…ç½®æ–‡ä»¶é…åˆä½¿ç”¨ï¼Œå¯ä»¥æé«˜åç«¯åŒäº‹çš„è°ƒè¯•æ•ˆç‡ã€‚

### ä¸ºä»€ä¹ˆé‡‡ç”¨æ’ä»¶

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå‰ç«¯é¡¹ç›®çš„é…ç½®æ–‡ä»¶ä¼šå•ç‹¬æ‹§å‡ºæ¥ï¼Œæ–¹æ³•ç½‘ç«™æ ¹ç›®å½•ä¸‹ã€‚å¦‚æœé¡¹ç›®éƒ¨ç½²éœ€è¦éƒ¨ç½²åœ¨ä¸åŒçš„ç¯å¢ƒæˆ–è€…å¹³å°ä¸­ï¼Œåªéœ€ä¿®æ”¹ config.js çš„åœ°å€å³å¯ã€‚æˆ‘ä»¬å¯ä»¥å°†å…¶æŒ‚è½½åˆ°`window`ä¸Šï¼Œä½¿ä¹‹æˆä¸ºä¸€ä¸ªå…¨å±€å˜é‡ã€‚é€šè¿‡æµè§ˆå™¨çš„æ§åˆ¶å°`console`ä¿®æ”¹ï¼Œè¿™ä¸ªæ²¡é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœé¡µé¢åˆ·æ–°ï¼Œä¿®æ”¹çš„å†…å®¹ç”±äºæ˜¯ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œä¼šè¢«æ¸…ç©ºã€‚

ä¸ºæ­¤ï¼Œä¿®æ”¹çš„å†…å®¹éœ€è¦æŒä¹…åŒ–å‚¨å­˜ã€‚æ²¡é”™ï¼Œæ•°æ®å¯ä»¥å‚¨å­˜åœ¨`storage`ä¸­ï¼Œé¡µé¢åˆ·æ–°åï¼Œå¯ä»¥ä»`storage`ä¸­è¯»å–åº”ç”¨ã€‚ä½†æ˜¯æ•°æ®åœ¨æ§åˆ¶å°ä¿®æ”¹æ¯•ç«Ÿå¾ˆç¹çï¼Œå› æ­¤è¿˜éœ€è¦ä¸€ä¸ªå¯è§†åŒ–çš„é¡µé¢å»ä¿®æ”¹æ•°æ®ï¼Œå°†æ•°æ®å­˜å‚¨åˆ°`storage`ä¸­ã€‚å¦‚æœå¼€å‘ä¸€ä¸ªå‰ç«¯é¡µé¢å»åšè¿™äº‹ï¼Œå°±æœ‰ç‚¹å¾—ä¸å¿å¤±ï¼Œè€Œé€‰æ‹©å¼€å‘æ’ä»¶æ˜¯ä¸€ç§æ›´ä¼˜çš„é€‰æ‹©ã€‚

### æ’ä»¶çš„ä»‹ç»ä¸å¼€å‘

è°·æ­Œçš„æ’ä»¶ç½‘ä¸Šæœ‰éå¸¸å¤šçš„æ–‡æ¡£ï¼Œæœ¬æ–‡åªè®²è¿°ä¸ºé¡¹ç›®å®šåˆ¶æ’ä»¶çš„æ ¸å¿ƒå®ç°ã€‚
å…¶æ•ˆæœå¦‚ä¸‹ï¼š
<img src="../../Demo/image/extentsion01.png"/>
<img src="../../Demo/image/extentsion02.png" />

#### æ’ä»¶çš„åŠŸèƒ½

æ’ä»¶æä¾›çš„åŠŸèƒ½éå¸¸ç®€å•ã€‚ç”¨æˆ·å®‰è£…æ’ä»¶åï¼Œå¯ä»¥åŠ¨æ€ä¿®æ”¹ æ¥å£åœ°å€ï¼Œé¡¹ç›®è‡ªåŠ¨åˆ·æ–°ï¼Œå¯ç”¨æ–°çš„æ¥å£åœ°å€è®¿é—®åå°ï¼›åœ¨ä¿®æ”¹æ¥å£åœ°å€åï¼Œä¹Ÿå¯ä»¥æ¢å¤é»˜è®¤é…ç½®ï¼Œç³»ç»Ÿä¼šå¯ç”¨é»˜è®¤åœ°å€ã€‚

æ’ä»¶è¦ä¸»è¦è§£å†³çš„é—®é¢˜å°±æ˜¯å°†è¾“å…¥çš„åœ°å€å­˜å‚¨åˆ°ç½‘é¡µçš„`storage`ä¸­ï¼Œç½‘é¡µä¼šå»è¯»å–`storage`çš„å€¼ï¼Œå¹¶åˆ·æ–°é¡µé¢ï¼Œåº”ç”¨æ–°å€¼ã€‚

å…¶æ ¸å¿ƒå·¥ä½œä¸å®ç°å¦‚ä¸‹ï¼š

#### `popup.html` ç•Œé¢

`popup.html`æä¾›æ•°æ®çš„å…¥å£ä»¥åŠäº¤äº’æ“ä½œç•Œé¢ï¼Œå…¶ä¸­è¿˜ä¼šå¼•å…¥`popup.js`

```html
<div class="container">
  <div class="formItem">
    <h3>MMSè‡ªå®šä¹‰APIåœ°å€ï¼š</h3>
    <img id="reset" title="é‡ç½®" />
  </div>
  <div>
    <p>BASE_URL:</p>
    <div class="formItem">
      <input type="text" id="baseURL" placeholder="http://" />
      <button id="btn">ä¿å­˜</button>
    </div>
  </div>
</div>
<script src="../js/popup.js"></script>
```

#### `popup.js`

`popup.js`çš„ä½œç”¨åŒ…æ‹¬è®¾ç½®å¼¹çª—å†…å®¹ã€å“åº”ç”¨æˆ·äº¤äº’ã€å¤„ç†äº‹ä»¶ä»¥åŠä¸åå°è„šæœ¬è¿›è¡Œæ•°æ®äº¤æ¢ã€‚ç”±äº`popup.js`æ— æ³•ä¸ç½‘é¡µè¿›è¡Œé€šä¿¡ï¼Œå› æ­¤éœ€è¦å€ŸåŠ©äºåå°è„šæœ¬ã€‚

å“åº”ç”¨æˆ·äº¤äº’ï¼Œå…¶å®ç°å¦‚ä¸‹ï¼Œé€šè¿‡`chrome.runtime.sendMessage`å‘`background.js`å‘é€æ¶ˆæ¯

```js
/** ç›‘å¬ä¿å­˜æŒ‰é’®äº‹ä»¶ */
doms.btn.addEventListener("click", () => {
  const val = doms.input.value;
  if (val) {
    if (isValidURL(val)) {
      //åˆ¤æ–­è¾“å…¥æ˜¯å¦æ˜¯åˆæ³•çš„url
      chrome.runtime.sendMessage(
        { action: "UPDATE_GLOBAL_VAR", value: val },
        (response) => {
          if (response.status === "success") {
            console.log("ğŸš€è®¾ç½®BASE_URLæˆåŠŸ");
            window.close();
          } else {
            alert("ğŸš€è®¾ç½®BASE_URLå¤±è´¥");
          }
        }
      );
    } else {
      doms.input.value = preValue;
      alert("æ¥å£åœ°å€ä¸åˆæ³•");
    }
  }
});
```

#### `background.js`

`background.js`ä¸»è¦ç”¨äºå¤„ç†æ’ä»¶çš„åå°é€»è¾‘å’Œç®¡ç†æ‰©å±•çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ­¤æ¬¡å¼€å‘ä¸­`background.js`ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š

- 1.å®‰è£…æˆåŠŸååˆå§‹åŒ–`storage.local`çš„å˜é‡
- 2.ç›‘å¬`popup.js`å‘é€çš„æ¶ˆæ¯ä»¥åŠæ¥æ”¶åˆ°æ¶ˆæ¯å,ç»™`popup.js`ä¸€ä¸ªåé¦ˆï¼Œå¹¶ä¸”å°†æ•°æ®é€šè¿‡`chrome.tab.sendMessage`å‘é€ç»™`content_script.js`

å…¶å®ç°å¦‚ä¸‹ï¼š

```js
// background.js
console.log("ğŸš€ åŠ è½½background.jsæˆåŠŸ");

// background.js
chrome.runtime.onInstalled.addListener(() => {
  chrome.storage.local.set({ globalVar: null });
});

chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.action === "UPDATE_GLOBAL_VAR") {
    chrome.storage.local.set({ globalVar: message.value });
    sendResponse({ status: "success" });
    chrome.tabs.query({ active: true, currentWindow: true }, function (tabs) {
      chrome.tabs.sendMessage(tabs[0].id, {
        type: "UPDATE_CONTENT",
        data: message.value,
      });
    });
  }
});
```

#### `content_script.js`

æ’ä»¶ä¸­çš„`content_script.js`å°±åƒä¸€ä¸ªä¸­è½¬ç«™ä¸€æ ·ï¼Œç”¨äºè„šæœ¬å’Œç½‘é¡µä¹‹é—´æ²Ÿé€šçš„æ¡¥æ¢ï¼Œç›‘å¬äºŒè€…çš„æ¶ˆæ¯å†è½¬å‘ã€‚

`content_script.js`ç”¨`chrome.runtime.onMessage`ç›‘å¬`background.js`çš„æ¶ˆæ¯ï¼Œå†é€šè¿‡`window.postMessage`è½¬å‘æ•°æ®ç»™ç½‘é¡µ
å…¶å®ç°å¦‚ä¸‹ï¼š

```js
chrome.runtime.onMessage.addListener(function (message, sender, sendResponse) {
  console.log("Message received in content script:", message);
  if (message.type === "UPDATE_CONTENT") {
    console.log("Data from background:", message.data);
    window.postMessage({
      type: _CONST_.FROM_CONTENT_SCRIPT,
      data: message.data,
    });
  }
});
```

æ­¤å¤–ï¼Œç”±äºæ’ä»¶è¿˜åšåˆ°äº†åˆå§‹é…ç½®çš„å›æ˜¾ï¼Œæ‰€ä»¥åœ¨`content_script.js`ä¸­è¿˜é€šè¿‡`window.addEventListener`ç›‘å¬äº†ç½‘é¡µçš„æ¶ˆæ¯ï¼Œå¦‚ä¸‹

```js
window.addEventListener("message", function (event) {
  if (
    event.source === window &&
    event.data.type &&
    event.data.type == _CONST_.FROM_CONTENT_WEBPAGE
  ) {
    console.log("ğŸš€ ~ WebPage`s Message received in content script:", event);

    // å®šä¹‰ä½ æƒ³è¦è·å–çš„æ•°æ®é”®
    const keys = ["globalVar"];

    chrome.storage.local.get(keys, function (result) {
      console.log("ğŸš€ ~ result:", result);
      // ç¡®ä¿è·å–çš„æ•°æ®å­˜åœ¨
      if (chrome.runtime.lastError) {
        console.error("Error retrieving data:", chrome.runtime.lastError);
        return;
      }

      const webPageValue = event.data.data;

      //å­˜å‚¨æœ€åˆå§‹çš„å€¼ï¼Œç”¨äºé‡ç½®
      if (result.globalVar == null) {
        chrome.storage.local.set({ originalValue: webPageValue });
      }
      // å¤„ç†è·å–çš„æ•°æ®
      if (result.globalVar != webPageValue) {
        chrome.storage.local.set({ globalVar: webPageValue });
      }
    });
  }
});
```

`content_script.js`æ¥æ”¶åˆ°ç½‘é¡µæ¶ˆæ¯åï¼Œå°†æ•°æ®å­˜å‚¨åœ¨`chrome.storage.local`ä¸­ã€‚

#### `config.js`

`config.js`ä¸å±äºæ’ä»¶çš„å†…å®¹ï¼Œå­˜åœ¨äºå‰ç«¯é¡¹ç›®ä¸­ï¼Œä½†æ˜¯`config.js`ç›¸å½“äºæ˜¯æ•°æ®çš„æœ€ç»ˆæ¥æ”¶æ–¹å’Œå“åº”å¯¹è±¡ã€‚

å…¶å®ç°å¦‚ä¸‹:

```js
window.addEventListener("message", function (event) {
  if (
    event.source === window &&
    event.data.type &&
    event.data.type == _CONST_.FROM_CONTENT_SCRIPT
  ) {
    window.localStorage.setItem(
      _CONST_.CONFIG_PLUGIN,
      JSON.stringify({ BASE_URL: event.data.data })
    );
    window.location.reload();
  }
});

let CONFIG_PLUGIN_STORAGE = window.localStorage.getItem(_CONST_.CONFIG_PLUGIN);

CONFIG_PLUGIN_STORAGE = CONFIG_PLUGIN_STORAGE
  ? JSON.parse(CONFIG_PLUGIN_STORAGE)
  : {};

window.config = {
  BASE_URL: "http://192.168.145.74:18430",
  ...CONFIG_PLUGIN_STORAGE,
};

window.postMessage({
  type: _CONST_.FROM_CONTENT_WEBPAGE,
  data: window.config.BASE_URL,
});
```

`config.js`çš„ä½œç”¨å¢å¼ºäº†ï¼Œé™¤äº†æä¾›æ¥å£åœ°å€ã€‚å®ƒè¿˜æ‰¿æ‹…äº†é‡è¦çš„ä½œç”¨ã€‚ä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š

- ç›‘å¬`content_script.js`è„šæœ¬å‘é€çš„æ¶ˆæ¯ï¼Œç„¶åå°†æ–°æ•°æ®å­˜å‚¨åˆ°`localStorage`ä¸­å»ï¼Œæœ€ååˆ·æ–°é¡µé¢
- è¯»å–`localStorage`ä¸­æ•°æ®ï¼Œç»„è£…æˆç¯å¢ƒåœ°å€æ¥å£
- å‘`content_script.js`å‘é€æ¶ˆæ¯

### æ€»ç»“

æ’ä»¶çš„å¼€å‘ä¸€å®šè¦ç¬¦åˆ chrome æ’ä»¶å¼€å‘è§„èŒƒï¼Œè„šæœ¬é—´çš„é€šä¿¡è¦ä¸€ ä¸€å¯¹åº”ã€‚é€šè¿‡`crx`æ ¼å¼å®‰è£…çš„æ‰©å±•æ’ä»¶çš„å‰ææ˜¯æ’ä»¶è¦æ‰“åŒ…å‘å¸ƒåœ¨ Chrome çš„åº”ç”¨å•†åº—ä¸­ï¼Œä¸€æ¬¡æ€§æ”¶è´¹`25$`ã€‚

[githubåœ°å€](https://github.com/Jinuss/chrome-extension-test)ï¼Œå¦‚æœå¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸€ä¸ªstarã€‚
