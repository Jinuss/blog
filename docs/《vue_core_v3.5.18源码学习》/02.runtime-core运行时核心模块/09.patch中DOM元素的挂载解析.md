---
title: patch中DOM元素的挂载解析
date: 2025-09-25 11:36:58
permalink: /pages/4e082f/
categories:
 - 《vue_core_v3.5.18源码学习》
  - runtime-core运行时核心模块
tags:
  - 
author: 
  name: 东流
  link: https://github.com/Jinuss
---

## 源码解析

```js
const mountElement = (vnode, container, anchor, parentComponent, parentSuspense, namespace, slotScopeIds, optimized) => {
  let el;
  let vnodeHook;
  const { props, shapeFlag, transition, dirs } = vnode;
  el = vnode.el = hostCreateElement(
    vnode.type,
    namespace,
    props && props.is,
    props
  );
  if (shapeFlag & 8) {
    hostSetElementText(el, vnode.children);
  } else if (shapeFlag & 16) {
    mountChildren(
      vnode.children,
      el,
      null,
      parentComponent,
      parentSuspense,
      resolveChildrenNamespace(vnode, namespace),
      slotScopeIds,
      optimized
    );
  }
  if (dirs) {
    invokeDirectiveHook(vnode, null, parentComponent, "created");
  }
  setScopeId(el, vnode, vnode.scopeId, slotScopeIds, parentComponent);
  if (props) {
    for (const key in props) {
      if (key !== "value" && !shared.isReservedProp(key)) {
        hostPatchProp(el, key, null, props[key], namespace, parentComponent);
      }
    }
    if ("value" in props) {
      hostPatchProp(el, "value", null, props.value, namespace);
    }
    if (vnodeHook = props.onVnodeBeforeMount) {
      invokeVNodeHook(vnodeHook, parentComponent, vnode);
    }
  }
  if (dirs) {
    invokeDirectiveHook(vnode, null, parentComponent, "beforeMount");
  }
  const needCallTransitionHooks = needTransition(parentSuspense, transition);
  if (needCallTransitionHooks) {
    transition.beforeEnter(el);
  }
  hostInsert(el, container, anchor);
  if ((vnodeHook = props && props.onVnodeMounted) || needCallTransitionHooks || dirs) {
    queuePostRenderEffect(() => {
      vnodeHook && invokeVNodeHook(vnodeHook, parentComponent, vnode);
      needCallTransitionHooks && transition.enter(el);
      dirs && invokeDirectiveHook(vnode, null, parentComponent, "mounted");
    }, parentSuspense);
  }
}
```

## 辅助方法

### `mountChildren`

```js
const mountChildren = (children, container, anchor, parentComponent, parentSuspense, namespace, slotScopeIds, optimized, start = 0) => {
    for (let i = start; i < children.length; i++) {
      const child = children[i] = optimized ? cloneIfMounted(children[i]) : normalizeVNode(children[i]);
      patch(
        null,
        child,
        container,
        anchor,
        parentComponent,
        parentSuspense,
        namespace,
        slotScopeIds,
        optimized
      );
    }
  };
```

### `setScopeId`

```js
const setScopeId = (el, vnode, scopeId, slotScopeIds, parentComponent) => {
  if (scopeId) {
    hostSetScopeId(el, scopeId)
  }
  if (slotScopeIds) {
    for (let i = 0; i < slotScopeIds.length; i++) {
      hostSetScopeId(el, slotScopeIds[i])
    }
  }
  if (parentComponent) {
    let subTree = parentComponent.subTree;
    if (vnode === subTree || isSuspense(subTree.type) && (subTree.ssContent === vnode || subTree.ssFallback === vnode)) {
      const parentVNode = parentComponent.vnode;
      setScopeId(el, parentVNode, parentVNode.scopeId, parentVNode.slotScopeIds, parentComponent.parent)
    }
  }
}
```