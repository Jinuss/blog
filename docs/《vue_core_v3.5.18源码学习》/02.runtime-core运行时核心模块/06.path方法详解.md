---
title: path方法详解
date: 2025-09-22 17:04:39
permalink: /pages/832bcf/
categories:
  - 5.18源码学习》
  - runtime-core运行时核心模块
tags:
  - 
author: 
  name: 东流
  link: https://github.com/Jinuss
---

```js
const patch=(n1,n2,container,anchor = null,parentComponent = null,parentSuspense = null,namespace = void 0,slotScopeIds = null,optimized = !! n2.dynamicChildren)=>{
   if(n1 === n2){
     return ;      
   }
   if(n1 && !isSameVNodeType(n1,n2)){
       anchor = getNextHostNode(n1);
       unmount(n1,parentComponent,parentSuspense,true);
       n1 = null;   
   }
   if(n2.patchFlag === -2){
     optimized = false;
     n2.dynamicChild = null;    
   } 
   const {type,ref,shapeFlag} = n2;
   switch(type){
    case Text:
        processText(n1,n2,container,anchor);
        break;
    case Comment:
        processCommentNode(n1,n2,container,anchor);
    case Static:
        if(n1 == null){
         mountStaticNode(n2,container,anchor,namespace);
        };  
        break;
    case Fragment:
        processFragment(n1,n2,container,anchor,parentComponent,parentSuspense,namespace,slotScopeIds,optimized);
        break;
    default:
        if(shapeFlag & 1){
          processElement(n1,n2,container,anchor,parentComponent,parentSuspense,namespace,slotScopedIds,optimized) 
        }else if(shapeFlag & 6){
         processComponent(n1,n2,container,anchor,parentComponent,
            parentSuspense,
            namespace,
            slotScopeIds,
            optimized)   
        }else if(shapeFlag & 64){
             type.process(
            n1,
            n2,
            container,
            anchor,
            parentComponent,
            parentSuspense,
            namespace,
            slotScopeIds,
            optimized,
            internals
          )else if (shapeFlag & 128) {
          type.process(
            n1,
            n2,
            container,
            anchor,
            parentComponent,
            parentSuspense,
            namespace,
            slotScopeIds,
            optimized,
            internals
          );;    
        }              
   }
   if(ref != null && parentComponent){
     setRef(ref,n1 && n1.ref,parentSuspense,n2||n1,!n2);  
   }else if(ref == null && n1 &&n1.ref !=null){
     setRef(n1.ref,null,parentSuspense,n1,true)   
   }
}
```
### 辅助方法

### `processText`更新文本

```js
const processText=(n1,n2,container,anchor)=>{
    if(n1 == null){
      hostInsert(n2.el = hostCreateText(n2.children),container,anchor)   
    }else{
      const el = n2.el=n1.el;
      if(n2.children !== n1.children){
        hostSetText(el,n2.children);   
      }
    }
}
```

### `processCommentNode` 更新注释节点

```js
const processCommentNode = (n1,n2,container,anchor)=>{
    if(n1 == null){
     hostInsert(n2.el = hostCreateComment(n2.children || ""),container,anchor)    
    }else{
     n2.el = n1.el;
    }
}
```

### `mountStaticNode` 挂载静态节点

```js
const mountStaticNode =(n2,container,anchor,namespace)=>{
  [n2.el,n2.anchor]=hostInsertStaticContent(n2.children,container,anchor,namespace,n2.el,n2.anchor)
}
```

### `processFragment` 处理片段

```js
const processFragment = (n1,n2,container,anchor,parentComponent,parentSuspense,namespace,slotScopeIds,optimized)=>{
    const fragmentStartAnchor = n2.el = n1?n1.el:hostCreateText("");
    const fragmentEndAnchor = n2.anchor = n1?n1.anchor:hostCreateText("");
    let {patchFlag,dynamicChildren,slotScopeIds,fragmentSlotScopeIds}=n2;
    if(fragmentSlotScopeIds){
      slotScopeIds = slotScopeIds?slotScopeIds.concat(fragmentSlotScopeIds):fragmentSlotScopeIds;     
    }
    if(n1 == null){
       hostInsert(fragmentStartAnchor,container,anchor);
       hostInsert(fragmentEndAnchor,container,anchor);
       mountChildren(n2.children||[],container,fragmentEndAnchor,parentComponent,parentSuspense,namespace,slotScopedIds,optimized)  
    }else {
       if(patchFlag > 0 &&patchFlag & 64 && dynamicChildren && n1.dynamicChildren){
         patchBlockChildren(n1.dynamicChildren,dynamicChildren,container,parentComponent,parentSuspense,namespace,slotScopeIds)     
       }

       if(n2.key != null || parentComponent && n2 === parentComponent.subTree){
         traverseStaticChildren(n1,n2,true)    
       }
    }else {
       patchChildren(n1,n2,container,fragmentEndAnchor,parentComponent,parentSuspense,namespace,slotScopedIds,optimized) 
    }
}
```

### `processElement` 更新元素

```js
const processElement = (n1, n2, container, anchor, parentComponent, parentSuspense, namespace, slotScopeIds, optimized) => {
    if (n2.type === "svg") {
      namespace = "svg";
    } else if (n2.type === "math") {
      namespace = "mathml";
    }
    if (n1 == null) {
      mountElement(
        n2,
        container,
        anchor,
        parentComponent,
        parentSuspense,
        namespace,
        slotScopeIds,
        optimized
      );
    } else {
      patchElement(
        n1,
        n2,
        parentComponent,
        parentSuspense,
        namespace,
        slotScopeIds,
        optimized
      );
    }
  };
```

### `processComponent`更新组件

```js
 const processComponent = (n1, n2, container, anchor, parentComponent, parentSuspense, namespace, slotScopeIds, optimized) => {
    n2.slotScopeIds = slotScopeIds;
    if (n1 == null) {
      if (n2.shapeFlag & 512) {
        parentComponent.ctx.activate(
          n2,
          container,
          anchor,
          namespace,
          optimized
        );
      } else {
        mountComponent(
          n2,
          container,
          anchor,
          parentComponent,
          parentSuspense,
          namespace,
          optimized
        );
      }
    } else {
      updateComponent(n1, n2, optimized);
    }
  };
```