---
title: 集合对象的代理
date: 2025-08-14 17:14:30
permalink: /pages/8964a6/
categories:
  - 《vue_core_v3.5.18源码学习》
  - reactivity响应式
tags:
  - 
author: 
  name: 东流
  link: https://github.com/Jinuss
---

## 概览

vue3中实现集合对象(`Map/WeakMap/Set/WeakSet`)的处理器方法，也是针对四种集合对象的代理方法，如：响应式集合对象、浅层响应式集合对象、只读集合对象和浅层只读集合对象。但是集合对象处理器方法没有使用`class`的集成实现，具体参见`packages\reactivity\src\collectionHandlers.ts`

## 源码分析

首先要理解集合对象的代理方法就是一个包含`get`方法的对象，如下所示：
```js
const mutableCollectionHandlers = {
  get: /* @__PURE__ */ createInstrumentationGetter(false, false)
};
const shallowCollectionHandlers = {
  get: /* @__PURE__ */ createInstrumentationGetter(false, true)
};
const readonlyCollectionHandlers = {
  get: /* @__PURE__ */ createInstrumentationGetter(true, false)
};
const shallowReadonlyCollectionHandlers = {
  get: /* @__PURE__ */ createInstrumentationGetter(true, true)
};
```
### `createInstrumentationGetter`

`createInstrumentationGetter`方法就是用于创建`getter`方法，接受两个参数：`isReadonly`（是否只读）和`shallow`（是否是浅层响应）。

`createInstrumentationGetter`的源码实现如下：

```js
function createInstrumentationGetter(isReadonly2, shallow) {
  const instrumentations = createInstrumentations(isReadonly2, shallow);
  return (target, key, receiver) => {
    if (key === "__v_isReactive") {
      return !isReadonly2;
    } else if (key === "__v_isReadonly") {
      return isReadonly2;
    } else if (key === "__v_raw") {
      return target;
    }
    return Reflect.get(
      hasOwn(instrumentations, key) && key in target ? instrumentations : target,
      key,
      receiver
    );
  };
}
```