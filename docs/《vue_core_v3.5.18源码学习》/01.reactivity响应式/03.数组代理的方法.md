---
title: 数组代理的方法
date: 2025-08-14 16:56:56
permalink: /pages/357b69/
categories:
  - 《vue_core_v3.5.18源码学习》
  - reactivity响应式
tags:
  - 
author: 
  name: 东流
  link: https://github.com/Jinuss
---

## 概览

vue3中对于普通的代理包含**对象**和**数组**两类，对于数组的方法是重写了许多方法，具体实现参见`packages\reactivity\src\arrayInstrumentations.ts`

`arrayInstrumentations`实际上就是一个对象，对象的属性就是数组的方法，属性值就是重写的方法。

在`BaseReactiveHandler`类的`get(target,key,receiver)`方法中，有如下代码：
```js
get(target, key, receiver) {
  /**省略 */
   const targetIsArray = isArray(target);
    if (!isReadonly2) {
      if (targetIsArray && hasOwn(arrayInstrumentations, key)) {
        return Reflect.get(arrayInstrumentations, key, receiver);
      }
    }  
  /**省略 */
}
```
可知，当对响应式对象`target`进行读取操作时，会判断`target`是否为数组，且是否`key`是否是`arrayInstrumentations`中实现的方法，若是，则调用`Reflect.get`读取`arrayInstrumentations`中实现的方法并返回。

## 源码分析

`arrayInstrumentations`中实现的方法有：`includes`, `indexOf`, `lastIndexOf`, `push`, `pop`, `shift`, `unshift`, `splice`

`arrayInstrumentations`的实现如下：

```js
const arrayInstrumentations = /* @__PURE__ */ createArrayInstrumentations();
function createArrayInstrumentations() {
  const instrumentations = {};
  ["includes", "indexOf", "lastIndexOf"].forEach((key) => {
    instrumentations[key] = function(...args) {
      const arr = toRaw(this);
      for (let i = 0, l = this.length; i < l; i++) {
        track(arr, "get", i + "");
      }
      const res = arr[key](...args);
      if (res === -1 || res === false) {
        return arr[key](...args.map(toRaw));
      } else {
        return res;
      }
    };
  });
  ["push", "pop", "shift", "unshift", "splice"].forEach((key) => {
    instrumentations[key] = function(...args) {
      pauseTracking();
      pauseScheduling();
      const res = toRaw(this)[key].apply(this, args);
      resetScheduling();
      resetTracking();
      return res;
    };
  });
  return instrumentations;
}
```

